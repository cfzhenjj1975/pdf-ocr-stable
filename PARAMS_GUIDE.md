# OCR v10.1 参数调整指南

## 📋 快速调整

### 位置
```
/home/zjj/pdf-ocr-stable/pdf_ocr_v10_1.py
```

### 配置类
```python
class Config:
    # 第 38-60 行
```

---

## 🔧 核心参数

### 1. DPI（清晰度 vs 速度）

```python
DPI = 180  # 当前值
```

| 值 | 速度 | 清晰度 | 适用场景 |
|----|------|--------|---------|
| 128 | 最快 | 一般 | 大字书籍 |
| 150 | 快 | 良好 | 普通书籍 |
| **180** | **中等** | **良好** | **平衡** |
| 200 | 慢 | 优秀 | 小字/古籍 |
| 300 | 最慢 | 最佳 | 档案级 |

**调整建议**:
- 速度优先：降到 150
- 质量优先：升到 200

---

### 2. IMAGE_MAX_SIZE（图片尺寸限制）

```python
IMAGE_MAX_SIZE = 1500  # 当前值
```

| 值 | 速度 | 显存占用 | 适用场景 |
|----|------|---------|---------|
| 1024 | 最快 | 低 | 小图 |
| 1280 | 快 | 中 | 普通 |
| **1500** | **中等** | **中** | **平衡** |
| 1600 | 慢 | 高 | 大图 |
| 2048 | 最慢 | 最高 | 超大图 |

---

### 3. DET_DB_THRESH（文字检测阈值）

```python
DET_DB_THRESH = 0.35  # 当前值
```

| 值 | 速度 | 误检 | 漏检 | 说明 |
|----|------|------|------|------|
| 0.25 | 慢 | 高 | 低 | 灵敏 |
| 0.30 | 中等 | 中 | 中 | 平衡 |
| **0.35** | **快** | **低** | **中** | **当前** |
| 0.40 | 最快 | 最低 | 高 | 严格 |

**调整建议**:
- 误检多：升到 0.40
- 漏检多：降到 0.30

---

### 4. DET_DB_BOX_THRESH（检测框阈值）

```python
DET_DB_BOX_THRESH = 0.45  # 当前值
```

| 值 | 框大小 | 速度 | 适用场景 |
|----|--------|------|---------|
| 0.35 | 大 | 慢 | 宽松 |
| 0.40 | 中 | 中等 | 平衡 |
| **0.45** | **小** | **快** | **当前** |
| 0.50 | 最小 | 最快 | 严格 |

---

### 5. DET_DB_UNCLIP_RATIO（检测框扩展）

```python
DET_DB_UNCLIP_RATIO = 1.1  # 当前值
```

| 值 | 扩展比例 | 速度 | 适用场景 |
|----|---------|------|---------|
| 1.0 | 不扩展 | 最快 | 紧凑 |
| **1.1** | **10%** | **快** | **当前** |
| 1.3 | 30% | 中等 | 平衡 |
| 1.6 | 60% | 慢 | 保护边缘 |
| 2.0 | 100% | 最慢 | 最大保护 |

---

### 6. DROP_SCORE（置信度过滤）

```python
DROP_SCORE = 0.60  # 当前值
```

| 值 | 过滤强度 | 速度 | 输出质量 |
|----|---------|------|---------|
| 0.30 | 弱 | 慢 | 保留多 |
| 0.45 | 中 | 中等 | 平衡 |
| **0.60** | **强** | **快** | **当前** |
| 0.70 | 最强 | 最快 | 过滤多 |

**注意**: 过高会丢失低置信度但正确的文字

---

### 7. CLEAN_GPU_INTERVAL（显存清理频率）

```python
CLEAN_GPU_INTERVAL = 80  # 当前值
```

| 值 | 清理频率 | 速度 | 稳定性 |
|----|---------|------|--------|
| 20 | 高 | 慢 | 最稳定 |
| 50 | 中 | 中等 | 稳定 |
| **80** | **低** | **快** | **当前** |
| 100 | 最低 | 最快 | 可能溢出 |

---

### 8. GPU_MEMORY_GB（GPU 显存分配）

```python
GPU_MEMORY_GB = 13.0  # 当前值
```

| 值 | 适用 GPU | 说明 |
|----|---------|------|
| 8.0 | 8GB 显卡 | 低显存 |
| 12.0 | 12GB 显卡 | 中等 |
| **13.0** | **16GB 显卡** | **当前** |
| 15.0 | 16GB 显卡 | 最大 |

**警告**: 不要超过物理显存的 90%

---

## 📊 参数组合预设

### 极速模式（~100-150 页/分钟）
```python
DPI = 150
IMAGE_MAX_SIZE = 1280
DET_DB_THRESH = 0.40
DET_DB_BOX_THRESH = 0.50
DET_DB_UNCLIP_RATIO = 1.0
DROP_SCORE = 0.65
CLEAN_GPU_INTERVAL = 100
```

### 平衡模式（~70-100 页/分钟）← 当前
```python
DPI = 180
IMAGE_MAX_SIZE = 1500
DET_DB_THRESH = 0.35
DET_DB_BOX_THRESH = 0.45
DET_DB_UNCLIP_RATIO = 1.1
DROP_SCORE = 0.60
CLEAN_GPU_INTERVAL = 80
```

### 高质量模式（~40-60 页/分钟）
```python
DPI = 200
IMAGE_MAX_SIZE = 1600
DET_DB_THRESH = 0.25
DET_DB_BOX_THRESH = 0.35
DET_DB_UNCLIP_RATIO = 1.6
DROP_SCORE = 0.40
CLEAN_GPU_INTERVAL = 50
```

### 档案级模式（~20-30 页/分钟）
```python
DPI = 300
IMAGE_MAX_SIZE = 2048
DET_DB_THRESH = 0.20
DET_DB_BOX_THRESH = 0.30
DET_DB_UNCLIP_RATIO = 2.0
DROP_SCORE = 0.30
CLEAN_GPU_INTERVAL = 20
```

---

## 🔍 问题诊断与调整

### 问题：误检多（把噪点当文字）
```python
# 调高检测阈值
DET_DB_THRESH = 0.40       # 0.35 → 0.40
DET_DB_BOX_THRESH = 0.50   # 0.45 → 0.50
```

### 问题：漏检多（文字没识别）
```python
# 调低检测阈值
DET_DB_THRESH = 0.25       # 0.35 → 0.25
DET_DB_BOX_THRESH = 0.35   # 0.45 → 0.35
DET_DB_UNCLIP_RATIO = 1.6  # 1.1 → 1.6
```

### 问题：速度慢
```python
# 降低 DPI 和尺寸
DPI = 150                  # 180 → 150
IMAGE_MAX_SIZE = 1280      # 1500 → 1280
DROP_SCORE = 0.65          # 0.60 → 0.65
CLEAN_GPU_INTERVAL = 100   # 80 → 100
```

### 问题：显存溢出
```python
# 减少显存占用
GPU_MEMORY_GB = 10.0       # 13.0 → 10.0
IMAGE_MAX_SIZE = 1280      # 1500 → 1280
CLEAN_GPU_INTERVAL = 30    # 80 → 30
```

### 问题：表格误判为竖排
```python
# 已在 v10.1 修复（严格表格检测）
# 无需调整
```

---

## 📝 调整步骤

1. **编辑文件**
   ```bash
   nano /home/zjj/pdf-ocr-stable/pdf_ocr_v10_1.py
   ```

2. **找到配置类**（约第 38 行）
   ```python
   class Config:
       DPI = 180  # 修改这里
   ```

3. **保存并重启**
   ```bash
   pkill -f pdf_ocr
   bash /home/zjj/pdf-ocr-stable/start_v10_1.sh
   ```

4. **监控效果**
   ```bash
   bash /home/zjj/pdf-ocr-stable/ocr_quick_status.sh
   ```

---

## ⚠️ 注意事项

1. **每次只调整 1-2 个参数**，便于观察效果
2. **记录调整前后的速度和質量**
3. **大幅调整后先测试 1-2 个文件**
4. **显存相关参数不要超过硬件限制**
5. **DPI 低于 128 可能导致小字识别失败**

---

## 📈 性能参考

| 配置 | 速度 | 置信度 | 适用场景 |
|------|------|--------|---------|
| 极速 | 100-150 页/分 | 0.80-0.85 | 快速预览 |
| **平衡** | **70-100 页/分** | **0.85-0.90** | **日常使用** |
| 高质量 | 40-60 页/分 | 0.90-0.95 | 正式出版 |
| 档案级 | 20-30 页/分 | 0.95-0.99 | 档案保存 |

---

**最后更新**: 2026-02-25  
**版本**: v10.1
