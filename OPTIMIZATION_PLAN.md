# OCR 速度优化方案 - 目标 120 页/分钟

## 📊 当前状态

| 版本 | 速度 | 置信度 | 状态 |
|------|------|--------|------|
| v5.0 基准 | 43.7 页/分 | 0.90 | ✅ 稳定 |
| v9.0 极速 | 56.5 页/分 | 0.87 | ✅ 稳定 |
| **目标** | **120 页/分** | **≥0.80** | 🎯 挑战 |

---

## 🔍 瓶颈分析

### 当前处理时间分解（单页）

```
┌─────────────────────────────────────────────────────────┐
│           单页处理时间分解（v9.0）                      │
├─────────────────────────────────────────────────────────┤
│  PDF 转图片：0.3 秒  (28%)  ← CPU                       │
│  版面分析：0.1 秒   (9%)   ← CPU                       │
│  OCR 识别：0.5 秒   (47%)  ← GPU（主要瓶颈！）         │
│  后处理：0.05 秒   (5%)   ← CPU                       │
│  保存 DOCX:0.12 秒  (11%)  ← CPU+ 磁盘                 │
├─────────────────────────────────────────────────────────┤
│  总计：1.07 秒/页 = 56 页/分钟                          │
│  目标：0.50 秒/页 = 120 页/分钟                         │
└─────────────────────────────────────────────────────────┘
```

### 需要提升的倍数

| 环节 | 当前 | 目标 | 提升倍数 |
|------|------|------|---------|
| OCR 识别 | 0.50 秒 | 0.20 秒 | 2.5 倍 |
| PDF 转图片 | 0.30 秒 | 0.15 秒 | 2 倍 |
| 保存 DOCX | 0.12 秒 | 0.08 秒 | 1.5 倍 |
| **综合** | 1.07 秒 | 0.50 秒 | 2.1 倍 |

---

## 🚀 优化方案

### 方案 A：多进程并行（推荐⭐⭐⭐⭐⭐）

**原理**：启动多个独立进程，每个进程有独立 GPU 上下文

```python
# 4 进程并行
进程 1: OCR 实例 1 → GPU 处理
进程 2: OCR 实例 2 → GPU 处理
进程 3: OCR 实例 3 → GPU 处理
进程 4: OCR 实例 4 → GPU 处理

理论速度：56.5 × 4 = 226 页/分钟
实际预期：56.5 × 1.8 = 102 页/分钟（GPU 竞争损耗）
```

**优点**：
- 充分利用 GPU 空闲时间
- 每个进程独立，无锁竞争

**风险**：
- 显存竞争可能导致错误
- 需要精细控制显存分配

---

### 方案 B：DPI 进一步降低（⭐⭐⭐）

```python
# v9.0
DPI = 150    # 56.5 页/分，置信度 0.87

# v11.0 测试
DPI = 128    # 预期 70 页/分，置信度 0.82-0.85
DPI = 100    # 预期 85 页/分，置信度 0.75-0.80⚠️
```

**风险**：
- DPI<128 小字识别置信度下降到 0.75-0.80
- 可能违反 0 错误率要求

---

### 方案 C：使用快速模型（⭐⭐⭐⭐）

```python
# 当前模型
PP-OCRv4_det + PP-OCRv4_rec  # 高精度，速度慢

# 快速模型
PP-OCRv3_mobile_det + PP-OCRv3_mobile_rec  # 速度↑50%，精度↓3%
```

**预期效果**：
- 速度提升 50%
- 置信度下降 0.02-0.03

---

### 方案 D：流水线并行（⭐⭐⭐⭐）

```
┌─────────────────────────────────────────────────────────┐
│              流水线并行处理                             │
├─────────────────────────────────────────────────────────┤
│  时间 →                                                │
│  进程 1: [转图片 1] [OCR 1] [后处理 1] [保存 1]         │
│  进程 2: [转图片 2] [OCR 2] [后处理 2] [保存 2]         │
│  进程 3: [转图片 3] [OCR 3] [后处理 3] [保存 3]         │
│                                                         │
│  传统：1+1+1+1 = 4 秒（串行）                          │
│  流水：1+max(1,1,1)+1 = 3 秒（并行）                   │
└─────────────────────────────────────────────────────────┘
```

**预期提升**：30-40%

---

### 方案 E：批处理优化（⭐⭐⭐）

```python
# 当前
单页识别 → GPU 利用率 35-53%

# 优化
4 页批处理 → GPU 利用率 70-85%

理论提升：50-60%
实际预期：20-30%（PaddleOCR 批处理支持有限）
```

---

## 🎯 综合优化方案 v11.0

### 参数组合

```python
# v11.0 120 页/分钟目标配置

# 1. 多进程并行
NUM_PROCESSES = 4              # 4 进程并行

# 2. DPI 优化
DPI = 128                      # 从 150 降到 128（+20%）

# 3. 图片尺寸
IMAGE_MAX_SIZE = 1152          # 从 1280 降到 1152（+10%）

# 4. 快速模型
USE_MOBILE_MODEL = True        # 使用 mobile 模型（+30%）

# 5. 检测参数优化
DET_DB_THRESH = 0.32           # 从 0.30 升到 0.32
DET_DB_BOX_THRESH = 0.42       # 从 0.40 升到 0.42
DET_DB_UNCLIP_RATIO = 1.2      # 从 1.3 降到 1.2
DROP_SCORE = 0.55              # 从 0.50 升到 0.55

# 6. 流水线
PIPELINE_ENABLED = True        # 启用流水线

# 7. 批处理
GPU_BATCH_SIZE = 4             # 4 页批处理
```

### 预期速度分解

| 优化项 | 当前 | 优化后 | 提升 |
|--------|------|--------|------|
| 基准速度 | 56.5 | 56.5 | - |
| 4 进程并行 | - | ×2.0 | +100% |
| DPI 150→128 | - | ×1.2 | +20% |
| 快速模型 | - | ×1.3 | +30% |
| 检测参数 | - | ×1.1 | +10% |
| 流水线 | - | ×1.2 | +20% |
| **综合** | 56.5 | **110-130** | **+100-130%** |

### 置信度风险

| 优化项 | 置信度影响 | 风险 |
|--------|-----------|------|
| DPI 150→128 | -0.03 | ⚠️ 中 |
| 快速模型 | -0.02 | ✅ 低 |
| 检测参数 | -0.01 | ✅ 低 |
| **综合** | **-0.06** | **⚠️ 0.87→0.81** |

**结论**：预期置信度 0.81，仍≥0.80（0 错误率边界）

---

## ⚠️ 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 显存竞争错误 | 中 | 高 | 限制进程数≤4 |
| 置信度<0.80 | 低 | 高 | 实时监测，自动降级 |
| 小字识别下降 | 中 | 中 | DPI 不低于 128 |
| 多进程同步问题 | 低 | 中 | 使用进程池 |

---

## 📋 实施步骤

1. **创建 v11.0 多进程版本**
2. **测试 4 进程稳定性**
3. **测试 DPI 128 置信度**
4. **测试快速模型精度**
5. **综合测试验证 120 页/分钟**

---

**目标：120 页/分钟，置信度≥0.80，0 错误率**
